<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Ideias | IdeiaFlow</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Supabase Client via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --background-rgb: 243, 244, 246;
            --foreground-rgb: 17, 24, 39;
            --card-bg-rgb: 255, 255, 255;
            --subtle-border-rgb: 229, 231, 235;
            --accent-rgb: 17, 24, 39;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: rgb(var(--background-rgb));
            color: rgb(var(--foreground-rgb));
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .glass-card {
            background: rgba(var(--card-bg-rgb), 0.6);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(var(--subtle-border-rgb), 0.2);
        }

        .btn-loading { cursor: not-allowed; opacity: 0.7; }
        
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-hidden .modal-backdrop { opacity: 0; }
        .modal-hidden .modal-content { opacity: 0; transform: translateY(20px) scale(0.95); }
        
        .active-tab { color: rgb(var(--accent-rgb)); }
        .active-tab-bg { background-color: rgba(var(--accent-rgb), 0.1); }
    </style>
</head>
<body class="overscroll-none">

    <!-- Fundo Decorativo -->
    <div class="fixed inset-0 -z-10 h-full w-full bg-white">
        <div class="absolute bottom-0 left-0 right-0 top-0 bg-[linear-gradient(to_right,#4f4f4f2e_1px,transparent_1px),linear-gradient(to_bottom,#4f4f4f2e_1px,transparent_1px)] bg-[size:14px_24px] [mask-image:radial-gradient(ellipse_80%_50%_at_50%_0%,#000_70%,transparent_110%)]"></div>
    </div>

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md p-8 space-y-8 glass-card rounded-3xl shadow-2xl">
            <div>
                <img class="mx-auto h-16 w-auto" src="https://raw.githubusercontent.com/nattanlima/ideiaflow/refs/heads/main/logo.png" alt="Logotipo IdeiaFlow">
                <h2 id="form-title" class="mt-6 text-center text-3xl font-bold tracking-tight text-gray-900">Acessar sua conta</h2>
            </div>
            <form id="auth-form" class="mt-8 space-y-6">
                <div class="rounded-xl shadow-sm -space-y-px">
                    <input id="phone" name="phone" type="tel" autocomplete="tel" required class="relative block w-full appearance-none rounded-t-xl border-0 bg-gray-100 px-4 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-gray-500 sm:text-sm" placeholder="Telefone com código do país">
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="relative block w-full appearance-none rounded-b-xl border-0 bg-gray-100 px-4 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-gray-500 sm:text-sm" placeholder="Senha (mínimo 6 caracteres)">
                </div>
                <button type="submit" id="submit-button" class="group relative flex w-full justify-center rounded-xl border border-transparent bg-gray-900 py-3 px-4 text-sm font-semibold text-white hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"><span id="button-text">Entrar</span></button>
            </form>
            <div class="text-sm text-center"><a href="#" id="toggle-form" class="font-medium text-gray-600 hover:text-gray-900">Não tem uma conta? Cadastre-se</a></div>
            <div id="message-box" class="text-center text-sm font-medium"></div>
        </div>
    </div>
    
    <!-- TELA DE CARREGAMENTO -->
    <div id="loading-screen" class="hidden flex items-center justify-center min-h-screen">
        <p class="text-gray-500">Carregando...</p>
    </div>

    <!-- TELA DO APLICATIVO -->
    <div id="app-screen" class="hidden w-full h-screen flex flex-col">
        <header class="p-4 flex justify-between items-center glass-card">
            <img src="https://raw.githubusercontent.com/nattanlima/ideiaflow/refs/heads/main/logo.png" class="h-8 w-auto" alt="Logotipo IdeiaFlow">
            <button id="profile-button" class="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center font-bold text-lg text-gray-700"></button>
        </header>

        <main id="kanban-content" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Cards -->
        </main>
        
        <button id="add-idea-fab" class="fixed bottom-24 right-5 w-16 h-16 bg-gray-900 text-white rounded-2xl shadow-lg flex items-center justify-center hover:bg-gray-800 transition-transform duration-200 active:scale-90">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        </button>

        <nav class="grid grid-cols-4 gap-2 p-2 m-4 rounded-2xl glass-card text-gray-500">
            <button class="nav-tab active-tab flex flex-col items-center p-2 rounded-lg" data-status="A FAZER"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg><span class="text-xs font-semibold">A Fazer</span></button>
            <button class="nav-tab flex flex-col items-center p-2 rounded-lg" data-status="EM ANDAMENTO"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="text-xs font-semibold">Em Andamento</span></button>
            <button class="nav-tab flex flex-col items-center p-2 rounded-lg" data-status="CONCLUÍDA"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="text-xs font-semibold">Concluída</span></button>
            <button class="nav-tab flex flex-col items-center p-2 rounded-lg" data-status="ARQUIVADA"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg><span class="text-xs font-semibold">Arquivada</span></button>
        </nav>
    </div>
    
    <!-- MODAIS -->
    <div id="idea-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden hidden">
        <div class="modal-backdrop fixed inset-0 bg-black/30"></div>
        <div class="modal-content w-full max-w-md p-6 glass-card rounded-3xl shadow-xl relative transform">
            <h3 id="idea-modal-title" class="text-2xl font-bold mb-6">Nova Ideia</h3>
            <form id="idea-form" class="space-y-4">
                <input type="hidden" id="idea-id">
                <input type="hidden" id="idea-is-public">
                <div>
                    <label for="idea-title" class="block text-sm font-medium mb-1">Título</label>
                    <input type="text" id="idea-title" required class="w-full p-3 border-0 rounded-xl bg-gray-100 focus:ring-2 focus:ring-gray-500">
                </div>
                <div>
                    <label for="idea-description" class="block text-sm font-medium mb-1">Descrição</label>
                    <textarea id="idea-description" rows="4" class="w-full p-3 border-0 rounded-xl bg-gray-100 focus:ring-2 focus:ring-gray-500"></textarea>
                </div>
                <div>
                    <label for="idea-status" class="block text-sm font-medium mb-1">Status</label>
                    <select id="idea-status" class="w-full p-3 border-0 rounded-xl bg-gray-100 focus:ring-2 focus:ring-gray-500">
                        <option>A FAZER</option> <option>EM ANDAMENTO</option> <option>CONCLUÍDA</option> <option>ARQUIVADA</option>
                    </select>
                </div>
                <div class="flex justify-between items-center pt-4">
                    <div id="share-options" class="flex items-center space-x-2">
                        <button type="button" id="copy-link-button" title="Copiar Link" class="p-3 rounded-xl font-semibold bg-gray-200 text-gray-800 flex items-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg>
                        </button>
                        <button type="button" id="whatsapp-share-button" title="Compartilhar no WhatsApp" class="p-3 rounded-xl font-semibold bg-green-500 text-white flex items-center">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413 0 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.687-1.475L.057 24zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.655 4.398 1.905 6.344l-.344 1.249 1.256-.327zM12 4.098c-4.327 0-7.829 3.5-7.832 7.828.001 1.453.386 2.828 1.12 4.026l.133.238-.832 2.417 2.464-.814.251.146c1.137.647 2.438 1.002 3.82 1.002 4.328 0 7.83-3.504 7.832-7.833.003-4.326-3.498-7.828-7.828-7.828zm.001 1.432c3.556 0 6.448 2.893 6.451 6.45.002 3.555-2.889 6.447-6.448 6.447-1.18 0-2.273-.312-3.22-.847l-.24-.124-.666 1.933 1.959-.645-.143-.244c-.945-1.61-1.427-3.442-1.426-5.358.002-3.555 2.894-6.448 6.448-6.448zm-2.325 3.301c-.126-.27-.262-.273-.388-.275-.113 0-.244-.003-.375.123-.131.126-.498.488-.498 1.195 0 .706.51 1.39.581 1.494.07.102 1.004 1.625 2.457 2.177.346.129.616.206.83.262.368.092.694.077.943-.059.297-.16.903-.438 1.028-.865.127-.426.127-.785.088-.864-.039-.079-.131-.126-.27-.205-.139-.079-.832-.411-1.004-.46-.172-.048-.297-.079-.423.079-.126.158-.498.62-.613.737-.113.116-.225.129-.423.048-.197-.08-.832-.308-1.589-.985-.59-.527-.985-1.176-1.103-1.373-.116-.197-.012-.308.068-.406.071-.087.158-.209.238-.314s.102-.172.158-.297c.056-.126.028-.238-.012-.315-.04-.079-.423-1.004-.581-1.374z"></path></svg>
                        </button>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" id="idea-modal-close" class="px-5 py-2 rounded-xl font-semibold bg-gray-200 text-gray-800">Cancelar</button>
                        <button type="submit" id="idea-modal-save" class="px-5 py-2 bg-gray-900 text-white rounded-xl font-semibold">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="profile-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden hidden">
        <div class="modal-backdrop fixed inset-0 bg-black/30"></div>
        <div class="modal-content w-full max-w-md p-6 glass-card rounded-3xl shadow-xl relative transform">
            <h3 class="text-2xl font-bold mb-6">Meu Perfil</h3>
            <form id="profile-form" class="space-y-6">
                <div>
                    <label for="profile-name" class="block text-sm font-medium mb-1">Nome</label>
                    <input type="text" id="profile-name" class="w-full p-3 border-0 rounded-xl bg-gray-100 focus:ring-2 focus:ring-gray-500">
                </div>
                <div class="flex justify-between items-center pt-4">
                    <button type="button" id="logout-button-modal" class="px-5 py-2 bg-red-500 text-white rounded-xl font-semibold">Sair</button>
                    <div>
                        <button type="button" id="profile-modal-close" class="px-5 py-2 rounded-xl font-semibold bg-gray-200 text-gray-800">Fechar</button>
                        <button type="submit" class="px-5 py-2 bg-gray-900 text-white rounded-xl font-semibold">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURAÇÃO ---
        const SUPABASE_URL = 'https://jqsusfxfabubionvjkso.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impxc3VzZnhmYWJ1YmlvbnZqa3NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDYxMDUsImV4cCI6MjA3MTYyMjEwNX0.jI2JEeMAiX1BK5JEufGoVv-yxdwbF402raSuWfkzDtg';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ESTADO GLOBAL ---
        let isLoginMode = true, allIdeas = [], currentUser = null, currentStatusFilter = 'A FAZER';

        // --- ELEMENTOS DO DOM ---
        const loginScreen = document.getElementById('login-screen'), appScreen = document.getElementById('app-screen'), loadingScreen = document.getElementById('loading-screen');
        const authForm = document.getElementById('auth-form'), phoneInput = document.getElementById('phone'), passwordInput = document.getElementById('password'), submitButton = document.getElementById('submit-button'), buttonText = document.getElementById('button-text'), messageBox = document.getElementById('message-box'), toggleFormLink = document.getElementById('toggle-form'), formTitle = document.getElementById('form-title');
        const profileButton = document.getElementById('profile-button'), kanbanContent = document.getElementById('kanban-content'), navTabs = document.querySelectorAll('.nav-tab'), addIdeaFab = document.getElementById('add-idea-fab');
        const ideaModal = document.getElementById('idea-modal'), ideaModalTitle = document.getElementById('idea-modal-title'), ideaForm = document.getElementById('idea-form'), ideaIdInput = document.getElementById('idea-id'), ideaTitleInput = document.getElementById('idea-title'), ideaDescriptionInput = document.getElementById('idea-description'), ideaStatusSelect = document.getElementById('idea-status'), ideaModalClose = document.getElementById('idea-modal-close'), ideaModalSave = document.getElementById('idea-modal-save'), shareOptions = document.getElementById('share-options'), copyLinkButton = document.getElementById('copy-link-button'), whatsappShareButton = document.getElementById('whatsapp-share-button');
        const profileModal = document.getElementById('profile-modal'), profileForm = document.getElementById('profile-form'), profileNameInput = document.getElementById('profile-name'), profileModalClose = document.getElementById('profile-modal-close'), logoutButtonModal = document.getElementById('logout-button-modal');

        // --- AUTENTICAÇÃO ---
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            try {
                if (session) {
                    loginScreen.classList.add('hidden');
                    appScreen.classList.add('hidden');
                    loadingScreen.classList.remove('hidden');

                    // CORREÇÃO: Encadeia as promessas para garantir a ordem
                    await fetchUserData();
                    await fetchAndRenderIdeas();
                    
                    loadingScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                } else {
                    loginScreen.classList.remove('hidden');
                    appScreen.classList.add('hidden');
                    loadingScreen.classList.add('hidden');
                    currentUser = null; allIdeas = [];
                }
            } catch (error) {
                console.error("Erro ao inicializar o app:", error);
                loadingScreen.classList.add('hidden');
                appScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                showMessage("Não foi possível carregar seus dados. Tente fazer o login novamente.", "error");
                await supabaseClient.auth.signOut();
            }
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault(); setLoading(true);
            const phone = phoneInput.value, password = passwordInput.value, email = `${phone}@example.com`;
            try {
                if (isLoginMode) {
                    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                } else {
                    const { data, error } = await supabaseClient.auth.signUp({ email, password, options: { data: { phone } } });
                    if (error) throw error;
                    if (!data.session) {
                        showMessage('Cadastro realizado! Por favor, faça o login.', 'success');
                        isLoginMode = true; updateFormUI();
                    }
                }
            } catch (error) { showMessage(`Erro: ${error.message}`, 'error'); } 
            finally { setLoading(false); }
        });
        
        logoutButtonModal.addEventListener('click', () => supabaseClient.auth.signOut());
        toggleFormLink.addEventListener('click', (e) => { e.preventDefault(); isLoginMode = !isLoginMode; updateFormUI(); });
        
        async function fetchUserData() {
            const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
            if (userError) throw new Error(`Erro ao buscar usuário: ${userError.message}`);
            if (user) {
                const { data, error } = await supabaseClient.from('usuarios').select('nome').eq('id', user.id).maybeSingle();
                if (error) throw new Error(`Erro ao buscar perfil: ${error.message}`);
                currentUser = data ? { ...user, nome: data.nome } : user;
                updateProfileUI();
            } else {
                throw new Error("Nenhum usuário logado encontrado.");
            }
        }

        // --- LÓGICA DO APP ---
        async function fetchAndRenderIdeas() {
            const { data, error } = await supabaseClient.from('ideias').select('*').order('created_at', { ascending: false });
            if (error) throw new Error(`Erro ao buscar ideias: ${error.message}`);
            allIdeas = data || [];
            renderIdeasByStatus();
        }

        function renderIdeasByStatus() {
            kanbanContent.innerHTML = '';
            const filteredIdeas = allIdeas.filter(idea => idea.status === currentStatusFilter);
            if (filteredIdeas.length === 0) {
                kanbanContent.innerHTML = `<div class="text-center text-gray-500 mt-10"><p class="font-semibold">Nenhuma ideia aqui!</p><p class="text-sm">Adicione uma nova ideia no botão +</p></div>`;
                return;
            }
            filteredIdeas.forEach(idea => kanbanContent.appendChild(createIdeaCard(idea)));
        }

        function createIdeaCard(idea) {
            const card = document.createElement('div');
            card.className = 'p-5 rounded-2xl shadow-lg cursor-pointer transition-transform duration-200 active:scale-95 glass-card';
            card.dataset.id = idea.id;
            const date = new Date(idea.created_at).toLocaleDateString('pt-BR');
            card.innerHTML = `
                <h3 class="font-bold text-lg mb-2 truncate">${idea.titulo}</h3>
                <p class="text-sm text-gray-500 mb-3 h-10 overflow-hidden text-ellipsis">${idea.descricao || ''}</p>
                <div class="flex items-center justify-between text-xs text-gray-400 pt-2 border-t" style="border-color: rgba(var(--subtle-border-rgb), 0.5)">
                    <span>ID: ${idea.id}</span>
                    <span>${date}</span>
                </div>
            `;
            card.addEventListener('click', () => openIdeaModal(idea));
            return card;
        }
        
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                navTabs.forEach(t => t.classList.remove('active-tab', 'active-tab-bg'));
                tab.classList.add('active-tab', 'active-tab-bg');
                currentStatusFilter = tab.dataset.status;
                renderIdeasByStatus();
            });
        });

        // --- LÓGICA DOS MODAIS ---
        function openModal(modal) { modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('modal-hidden'), 10); }
        function closeModal(modal) { modal.classList.add('modal-hidden'); setTimeout(() => modal.classList.add('hidden'), 300); }

        function openIdeaModal(idea = null) {
            ideaForm.reset();
            ideaModalTitle.textContent = idea ? 'Editar Ideia' : 'Nova Ideia';
            ideaIdInput.value = idea ? idea.id : '';
            ideaTitleInput.value = idea ? idea.titulo : '';
            ideaDescriptionInput.value = idea ? idea.descricao : '';
            ideaStatusSelect.value = idea ? idea.status : currentStatusFilter;
            shareOptions.style.display = idea ? 'flex' : 'none';
            openModal(ideaModal);
        }

        addIdeaFab.addEventListener('click', () => openIdeaModal());
        ideaModalClose.addEventListener('click', () => closeModal(ideaModal));
        ideaModal.querySelector('.modal-backdrop').addEventListener('click', () => closeModal(ideaModal));
        
        ideaForm.addEventListener('submit', async (e) => {
            e.preventDefault(); ideaModalSave.classList.add('btn-loading'); ideaModalSave.disabled = true;
            const ideaData = {
                titulo: ideaTitleInput.value, descricao: ideaDescriptionInput.value,
                status: ideaStatusSelect.value, user_id: currentUser.id
            };
            const id = ideaIdInput.value;
            const { error } = id ? await supabaseClient.from('ideias').update(ideaData).eq('id', id) : await supabaseClient.from('ideias').insert([ideaData]);
            ideaModalSave.classList.remove('btn-loading'); ideaModalSave.disabled = false;
            if (error) { alert(`Erro: ${error.message}`); } 
            else { closeModal(ideaModal); await fetchAndRenderIdeas(); }
        });

        copyLinkButton.addEventListener('click', async () => {
            const id = ideaIdInput.value;
            if (!id) return;
            const { error } = await supabaseClient.from('ideias').update({ is_public: true }).eq('id', id);
            if (error) { alert('Erro ao compartilhar ideia.'); return; }
            const shareUrl = `${window.location.origin}/share.html?id=${id}`;
            const originalTitle = copyLinkButton.title;
            navigator.clipboard.writeText(shareUrl).then(() => {
                copyLinkButton.title = 'Link Copiado!';
                setTimeout(() => { copyLinkButton.title = originalTitle; }, 2000);
            });
        });
        
        whatsappShareButton.addEventListener('click', async () => {
            const id = ideaIdInput.value;
            if (!id) return;
            const { error } = await supabaseClient.from('ideias').update({ is_public: true }).eq('id', id);
            if (error) { alert('Erro ao preparar compartilhamento.'); return; }
            const shareUrl = `${window.location.origin}/share.html?id=${id}`;
            const text = `Ei! ✨\n\nDá uma olhada nesta ideia que organizei no IdeiaFlow:\n\n${shareUrl}\n\nÉ uma ferramenta que estou usando para salvar e organizar minhas ideias de marketing. Achei que você ia gostar! 😉`;
            const encodedText = encodeURIComponent(text);
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodedText}`;
            window.open(whatsappUrl, '_blank');
        });

        function updateProfileUI() {
            if (currentUser) {
                profileNameInput.value = currentUser.nome || '';
                profileButton.textContent = (currentUser.nome || 'P').charAt(0).toUpperCase();
            }
        }

        profileButton.addEventListener('click', () => openModal(profileModal));
        profileModalClose.addEventListener('click', () => closeModal(profileModal));
        profileModal.querySelector('.modal-backdrop').addEventListener('click', () => closeModal(profileModal));

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { error } = await supabaseClient.from('usuarios').update({ nome: profileNameInput.value }).eq('id', currentUser.id);
            if (error) { alert(`Erro: ${error.message}`); } 
            else { await fetchUserData(); closeModal(profileModal); }
        });
        
        // --- FUNÇÕES AUXILIARES DE UI ---
        function updateFormUI() {
            formTitle.textContent = isLoginMode ? 'Acessar sua conta' : 'Crie sua conta';
            buttonText.textContent = isLoginMode ? 'Entrar' : 'Cadastrar';
            toggleFormLink.textContent = isLoginMode ? 'Não tem uma conta? Cadastre-se' : 'Já tem uma conta? Faça login';
            messageBox.textContent = '';
        }

        function setLoading(isLoading) {
            submitButton.disabled = isLoading;
            buttonText.textContent = isLoading ? 'Aguarde...' : (isLoginMode ? 'Entrar' : 'Cadastrar');
            submitButton.classList.toggle('btn-loading', isLoading);
        }

        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `text-center text-sm font-medium ${type === 'error' ? 'text-red-500' : 'text-green-500'}`;
        }
    </script>
</body>
</html>
